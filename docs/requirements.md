# mt. inn 修繕報告 PWA 要件定義書

## 1. 概要

### 1.1 目的
mt. inn（ホテル）のスタッフが、修繕が必要な箇所を写真撮影と音声入力で簡単に報告できるPWA（Progressive Web App）を構築する。報告データはGoogle スプレッドシートに蓄積され、AI（Gemini）による自動解析・稟議書自動生成・Chat通知が行われる。

### 1.2 背景
現行システムはiPhoneショートカット経由のメール送信をトリガーとしており、以下の課題がある：
- メール経由のため処理に5分のタイムラグがある
- iPhoneショートカットの設定が複雑
- 新しいスタッフへの導入コストが高い

### 1.3 解決策
PWAにより、スマートフォンのブラウザから直接報告を送信。ホーム画面に追加でネイティブアプリのように利用可能。

## 2. 機能要件

### 2.1 報告フォーム
| 項目 | 仕様 |
|------|------|
| 報告者名 | ドロップダウン選択（スタッフ名リスト） + 「その他」で自由入力 |
| 写真 | 最大3枚、カメラ撮影またはギャラリーから選択 |
| 修繕内容 | テキスト入力 + 音声入力（日本語） |

### 2.2 写真機能
- iPhone/Androidのカメラを直接起動
- 撮影後、1024px幅に自動リサイズ（通信量削減）
- サムネイルプレビュー表示
- 写真の削除（個別）

### 2.3 音声入力
- Web Speech API（日本語）によるリアルタイム文字起こし
- マイクボタンで開始/停止
- 認識中のテキストをリアルタイム表示
- 確定テキストをテキストエリアに自動追加

### 2.4 データ送信
- GAS Web App へのJSON POST
- 送信中ローディング表示
- 成功/エラーメッセージ表示

### 2.5 オフライン対応
- Service Workerによるアプリ資材キャッシュ
- オフライン時はIndexedDBに報告をキュー保存
- オンライン復帰時に自動再送信

## 3. 非機能要件

### 3.1 対応環境
- iOS Safari 15+（iPhone SE以降）
- Android Chrome 90+
- デスクトップ Chrome/Edge/Firefox（管理用）

### 3.2 PWA要件
- HTTPS提供（GitHub Pages）
- manifest.json によるインストール対応
- Service Worker によるオフラインキャッシュ
- ホーム画面アイコン（192x192, 512x512）

### 3.3 パフォーマンス
- 画像リサイズ: 1024px幅、JPEG品質80%
- 初回ロード: 1MB未満
- 送信レスポンス: GAS処理時間（30秒〜1分）

### 3.4 セキュリティ
- 認証なし（内部利用のみ）
- HTTPS通信
- GAS Web App: 「全員（匿名ユーザーを含む）」でデプロイ

## 4. システム構成

```
[iPhone PWA]
  ├── GitHub Pages (HTTPS)
  └── POST → [GAS Web App]
                ├── Gemini AI 解析
                ├── Google Sheets 記録
                ├── Google Docs 稟議書生成
                └── Google Chat 通知
```

### 4.1 フロントエンド
- ホスティング: GitHub Pages
- 技術: HTML5, CSS3, JavaScript (Vanilla)
- PWA: manifest.json, Service Worker

### 4.2 バックエンド
- 実行環境: Google Apps Script
- API: GAS Web App (doPost)
- AI: Gemini 2.5 Flash / 1.5 Pro
- データ: Google Sheets (42列)
- ドキュメント: Google Docs テンプレート

## 5. データフロー

1. スタッフがPWAで写真撮影・テキスト/音声入力
2. 画像を1024px幅にリサイズ、base64エンコード
3. JSON形式でGAS Web Appに送信
4. GASが画像をGoogle Driveにアップロード
5. Gemini AIが画像・テキストを解析（23項目出力）
6. スプレッドシートに42列のデータを記録
7. テンプレートから稟議書Docsを自動生成
8. Google ChatにCards V2通知（承認ボタン付き）
9. PWAに成功レスポンスを返却

## 6. 画面遷移

```
[報告フォーム] → [送信中] → [成功] → [新規報告]
                          → [エラー] → [再試行] → [報告フォーム]
                          → [オフライン保存] → (自動再送信)
```
